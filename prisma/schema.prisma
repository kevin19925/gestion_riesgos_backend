generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// Modelos de Seguridad y Usuarios
// ============================================

model Usuario {
  id        Int      @id @default(autoincrement())
  nombre    String
  email     String   @unique
  password  String   // Encriptada
  role      String   // 'admin', 'dueño_procesos', 'supervisor', 'gerente_general'
  cargoId   Int?
  cargo     Cargo?   @relation(fields: [cargoId], references: [id])
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  procesosResponsable Proceso[] @relation("ResponsableProceso")
  areasDirector       Area[]    @relation("DirectorArea")
  
  notificaciones      Notificacion[]
  tareas              Tarea[]
  observaciones       Observacion[] @relation("AutorObservacion")
  historialCambios    HistorialCambioProceso[]
  procesosParticipantes Proceso[] @relation("Participantes")
}

model Cargo {
  id          Int       @id @default(autoincrement())
  nombre      String    @unique
  descripcion String?
  usuarios    Usuario[]
}

model Gerencia {
  id          Int      @id @default(autoincrement())
  nombre      String   @unique
  sigla       String?
  subdivision String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Area {
  id          Int      @id @default(autoincrement())
  nombre      String   @unique
  descripcion String?
  directorId  Int?
  director    Usuario? @relation("DirectorArea", fields: [directorId], references: [id])
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  procesos    Proceso[]
}

// ============================================
// Modelos Principales del Sistema
// ============================================

model Proceso {
  id              Int      @id @default(autoincrement())
  nombre          String   @unique
  descripcion     String?
  objetivo        String?
  tipo            String?  // Estratégico, Operacional, etc.
  
  responsableId   Int
  responsable     Usuario  @relation("ResponsableProceso", fields: [responsableId], references: [id])
  
  areaId          Int
  area            Area     @relation(fields: [areaId], references: [id])
  
  // Campos adicionales para reportes
  vicepresidencia String?
  gerencia        String?
  
  estado          String   @default("borrador") // borrador, en_revision, aprobado
  activo          Boolean  @default(true)
  
  // Análisis y documentación
  analisis        String?  @db.Text
  documentoUrl    String?
  documentoNombre String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  riesgos         Riesgo[]
  observaciones   Observacion[]
  historial       HistorialCambioProceso[]
  
  // Detalle del Proceso
  dofaItems       DofaItem[]
  normatividades  Normatividad[]
  contextos       Contexto[]
  benchmarking    Benchmarking[]
  participantes   Usuario[] @relation("Participantes")
  documentos      Documento[]
}

model DofaItem {
  id          Int      @id @default(autoincrement())
  procesoId   Int
  proceso     Proceso  @relation(fields: [procesoId], references: [id], onDelete: Cascade)
  tipo        String   // FORTALEZA, OPORTUNIDAD, DEBILIDAD, AMENAZA, FO, FA, DO, DA
  descripcion String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Normatividad {
  id                    Int      @id @default(autoincrement())
  procesoId             Int
  proceso               Proceso  @relation(fields: [procesoId], references: [id], onDelete: Cascade)
  numero                Int
  nombre                String
  estado                String   // Proyecto, Requerida, Existente
  regulador             String?
  sanciones             String?
  plazoImplementacion   String?
  cumplimiento          String?  // Total, Parcial, No cumple
  detalleIncumplimiento String?
  riesgoIdentificado    String?
  clasificacion         String?  // Positiva, Negativa
  comentarios           String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model Contexto {
  id          Int      @id @default(autoincrement())
  procesoId   Int
  proceso     Proceso  @relation(fields: [procesoId], references: [id], onDelete: Cascade)
  tipo        String   // INTERNO, EXTERNO
  descripcion String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Riesgo {
  id              Int      @id @default(autoincrement())
  procesoId       Int
  proceso         Proceso  @relation(fields: [procesoId], references: [id])
  numero          Int
  descripcion     String
  clasificacion   String? // Negativa, Positiva
  zona            String?
  numeroIdentificacion String? // ID visual con siglas (ej: 1GTH)
  
  // Clasificación y Tipología
  tipologiaNivelI String?
  tipologiaNivelII String?
  
  // Relaciones con catálogos (opcionalmente normalizado)
  tipoRiesgoId    Int?
  tipoRiesgo      TipoRiesgo? @relation(fields: [tipoRiesgoId], references: [id])
  
  subtipoRiesgoId Int?
  subtipoRiesgo   SubtipoRiesgo? @relation(fields: [subtipoRiesgoId], references: [id])
  
  objetivoId      Int?
  objetivo        Objetivo? @relation(fields: [objetivoId], references: [id])
  
  // Campos de Texto para compatibilidad o flexibilidad
  causaRiesgo     String? // Texto resumen
  fuenteCausa     String? // Texto resumen
  origen          String?
  
  vicepresidenciaGerenciaAlta String?
  siglaVicepresidencia String?
  gerencia        String?
  siglaGerencia   String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relaciones Uno a Uno / Uno a Muchos
  evaluacion      EvaluacionRiesgo?
  causas          CausaRiesgo[]
  priorizacion    PriorizacionRiesgo?
  eventosMaterializados EventoMaterializado[]

  @@unique([procesoId, numero])
}

model CausaRiesgo {
  id              Int      @id @default(autoincrement())
  riesgoId        Int
  riesgo          Riesgo   @relation(fields: [riesgoId], references: [id], onDelete: Cascade)
  descripcion     String
  fuenteCausa     String? // 'Personas', 'Procesos', 'Externos'...
  
  // Atributos específicos
  frecuencia      String? // 'Probable', 'Posible'...
  seleccionada    Boolean @default(false)
  orden           Int?
  
  // Relaciones con Controles
  controles       ControlRiesgo[]
}

model ControlRiesgo {
  id              Int         @id @default(autoincrement())
  causaRiesgoId   Int
  causaRiesgo     CausaRiesgo @relation(fields: [causaRiesgoId], references: [id], onDelete: Cascade)
  descripcion     String
  tipoControl     String?     // AUTOMATICO, MANUAL...
  responsable     String?
  
  // Calificación del control (Puntajes)
  aplicabilidad   Int?
  cobertura       Int?
  facilidadUso    Int?
  segregacion     Int?
  naturaleza      Int?
  desviaciones    Int?
  puntajeControl  Int?
  
  evaluacionPreliminar String?
  evaluacionDefinitiva String?
  
  estandarizacionPorcentajeMitigacion Int?
  
  // Campos para persistencia de cálculo residual
  disminuyeFrecuenciaImpactoAmbas String? // FRECUENCIA, IMPACTO, AMBAS
}

model EvaluacionRiesgo {
  id                  Int      @id @default(autoincrement())
  riesgoId            Int      @unique
  riesgo              Riesgo   @relation(fields: [riesgoId], references: [id], onDelete: Cascade)
  
  impactoPersonas     Int
  impactoLegal        Int
  impactoAmbiental    Int
  impactoProcesos     Int
  impactoReputacion   Int
  impactoEconomico    Int
  impactoTecnologico  Int
  probabilidad        Int
  
  impactoGlobal       Int
  impactoMaximo       Int
  riesgoInherente     Int
  nivelRiesgo         String
  
  // Residual Values
  probabilidadResidual Int?
  impactoResidual      Int?
  riesgoResidual       Int?
  nivelRiesgoResidual  String?
  
  evaluadoPor         String?
  fechaEvaluacion     DateTime @default(now())
}

model PriorizacionRiesgo {
  id                  Int      @id @default(autoincrement())
  riesgoId            Int      @unique
  riesgo              Riesgo   @relation(fields: [riesgoId], references: [id], onDelete: Cascade)
  
  calificacionFinal   Int?
  respuesta           String? // Aceptar, Mitigar, Transferir...
  responsable         String?
  puntajePriorizacion Int?
  fechaAsignacion     DateTime @default(now())
  
  planesAccion        PlanAccion[]
}

model PlanAccion {
  id                  Int      @id @default(autoincrement())
  priorizacionId      Int
  priorizacion        PriorizacionRiesgo @relation(fields: [priorizacionId], references: [id], onDelete: Cascade)
  descripcion         String
  responsable         String?
  fechaInicio         DateTime?
  fechaFin            DateTime?
  estado              String // Pendiente, En Progreso, Completado
}

// ============================================
// Catálogos y Configuración
// ============================================

model TipoRiesgo {
  id          Int      @id @default(autoincrement())
  codigo      String   @unique
  nombre      String   @unique
  descripcion String?
  subtipos    SubtipoRiesgo[]
  riesgos     Riesgo[]
}

model SubtipoRiesgo {
  id           Int        @id @default(autoincrement())
  codigo       String?
  nombre       String
  descripcion  String?
  tipoRiesgoId Int
  tipoRiesgo   TipoRiesgo @relation(fields: [tipoRiesgoId], references: [id], onDelete: Cascade)
  riesgos      Riesgo[]

  @@unique([nombre, tipoRiesgoId], name: "nombre_tipo")
}

model Objetivo {
  id          Int      @id @default(autoincrement())
  codigo      String   @unique
  descripcion String   @unique
  riesgos     Riesgo[]
}

model Formula {
  id          Int      @id @default(autoincrement())
  nombre      String   @unique
  descripcion String?
  formula     String
  categoria   String?
  activa      Boolean  @default(true)
  variables   String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model MapaConfig {
  id          Int      @id @default(autoincrement())
  nombre      String
  ejes        String? // JSON storing X and Y definitions
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Configuracion {
  id          Int      @id @default(autoincrement())
  clave       String   @unique
  valor       String
  tipo        String
  descripcion String?
}

// ============================================
// Utilidades: Notificaciones, Tareas, Obs
// ============================================

model Notificacion {
  id        Int      @id @default(autoincrement())
  usuarioId Int
  usuario   Usuario  @relation(fields: [usuarioId], references: [id])
  titulo    String
  mensaje   String
  leida     Boolean  @default(false)
  tipo      String
  createdAt DateTime @default(now())
}

model Tarea {
  id          Int      @id @default(autoincrement())
  usuarioId   Int
  usuario     Usuario  @relation(fields: [usuarioId], references: [id])
  titulo      String
  descripcion String
  estado      String
  prioridad   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Observacion {
  id        Int      @id @default(autoincrement())
  procesoId Int
  proceso   Proceso  @relation(fields: [procesoId], references: [id], onDelete: Cascade)
  autorId   Int
  autor     Usuario  @relation("AutorObservacion", fields: [autorId], references: [id])
  texto     String
  tipo      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model HistorialCambioProceso {
  id          Int      @id @default(autoincrement())
  procesoId   Int
  proceso     Proceso  @relation(fields: [procesoId], references: [id], onDelete: Cascade)
  usuarioId   Int
  usuario     Usuario  @relation(fields: [usuarioId], references: [id])
  tipo        String
  mensaje     String
  fecha       DateTime @default(now())
  cambios     String?  // JSON string
}

model EventoMaterializado {
  id              Int      @id @default(autoincrement())
  riesgoId        Int
  riesgo          Riesgo   @relation(fields: [riesgoId], references: [id], onDelete: Cascade)
  descripcion     String
  fecha           DateTime
  impactoEconomico Float?
  planAccion      String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Benchmarking {
  id          Int      @id @default(autoincrement())
  procesoId   Int
  proceso     Proceso  @relation(fields: [procesoId], references: [id], onDelete: Cascade)
  entidad     String
  indicador   String
  valor       String
  comparacion String // Mejor, Igual, Peor
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Documento {
  id          Int      @id @default(autoincrement())
  procesoId   Int
  proceso     Proceso  @relation(fields: [procesoId], references: [id], onDelete: Cascade)
  nombre      String
  tipo        String   // 'analisis_proceso', 'normatividad', 'contexto', 'dofa', 'benchmarking', 'otro'
  url         String?
  contenido   String?  @db.Text
  tamaño      Int?     // bytes
  formato     String?  // 'pdf', 'docx', 'xlsx', etc
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
